---
import Layout from '../../../layouts/Layout.astro';
import Footer from '../../../components/Footer.astro';
import PublicationCard from '../../../components/PublicationCard.astro';
import Badge from '../../../components/ui/Badge.astro';
import { getCollection } from 'astro:content';
import { languages, useTranslations, type Lang } from '../../../i18n/index';
import { getLocalizedPath } from '../../../i18n/utils';

export function getStaticPaths() {
    return Object.keys(languages).map((lang) => ({
        params: { lang },
    }));
}

const { lang } = Astro.params as { lang: Lang };
const t = useTranslations(lang);

const publications = (await getCollection('publications')).sort(
    (a, b) => b.data.year - a.data.year
);

// Group publications by year
const publicationsByYear = publications.reduce((acc, pub) => {
    const year = pub.data.year;
    if (!acc[year]) {
        acc[year] = [];
    }
    acc[year].push(pub);
    return acc;
}, {} as Record<number, typeof publications>);

const years = Object.keys(publicationsByYear).sort((a, b) => Number(b) - Number(a));
---

<Layout title={`${t('publications.title')} | Jonas Wilinski`} lang={lang}>
    <!-- BreadcrumbList JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
            { "@type": "ListItem", "position": 1, "name": "Home", "item": `https://wilinski.me/${lang}` },
            { "@type": "ListItem", "position": 2, "name": t('publications.title') }
        ]
    })} />

    <main class="pt-24 pb-16">
        <!-- Header -->
        <section class="px-6 md:px-8 mb-12 md:mb-16">
            <div class="max-w-4xl mx-auto">
                <div data-reveal>
                    <span class="text-xs font-bold uppercase tracking-wider text-accent mb-2 block">
                        {t('publications.label')}
                    </span>
                    <h1 class="font-display font-bold text-4xl md:text-5xl lg:text-6xl text-neutral-900 dark:text-white mb-4">
                        {t('publications.title')}
                    </h1>
                    <p class="text-lg text-neutral-600 dark:text-neutral-400 max-w-2xl">
                        {t('publications.description')}
                    </p>
                </div>

                <!-- Stats -->
                <div class="flex items-center gap-6 mt-8" data-reveal>
                    <div class="flex items-center gap-2">
                        <span class="font-display font-bold text-2xl text-neutral-900 dark:text-white">
                            {publications.length}
                        </span>
                        <span class="text-sm text-neutral-500 dark:text-neutral-400">
                            {t('publications.count')}
                        </span>
                    </div>
                    <div class="w-px h-6 bg-neutral-200 dark:bg-neutral-700"></div>
                    <div class="flex items-center gap-2">
                        <span class="font-display font-bold text-2xl text-neutral-900 dark:text-white">
                            {years.length}
                        </span>
                        <span class="text-sm text-neutral-500 dark:text-neutral-400">
                            {t('publications.yearsActive')}
                        </span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Publications List -->
        <section class="px-6 md:px-8">
            <div class="max-w-4xl mx-auto">
                {years.map((year, yearIndex) => (
                    <div class="mb-12" data-reveal style={`--stagger-index: ${yearIndex}`}>
                        <!-- Year Header -->
                        <div class="sticky top-20 z-10 py-4 bg-white/80 dark:bg-neutral-900/80 backdrop-blur-lg -mx-6 px-6 mb-6 border-b border-neutral-200 dark:border-neutral-800">
                            <h2 class="font-display font-bold text-xl text-neutral-900 dark:text-white">
                                {year}
                            </h2>
                        </div>

                        <!-- Publications for this year -->
                        <div class="space-y-6">
                            {publicationsByYear[Number(year)].map((publication, index) => (
                                <div data-reveal style={`--stagger-index: ${index}`}>
                                    <PublicationCard {...publication.data} slug={publication.id} lang={lang} />
                                </div>
                            ))}
                        </div>
                    </div>
                ))}

                {publications.length === 0 && (
                    <div class="text-center py-20">
                        <p class="text-neutral-500 dark:text-neutral-400">
                            {t('publications.noPubs')}
                        </p>
                    </div>
                )}
            </div>
        </section>

        <!-- CTA -->
        <section class="px-6 md:px-8 mt-16">
            <div class="max-w-4xl mx-auto">
                <div class="p-8 md:p-12 rounded-3xl bg-neutral-100 dark:bg-neutral-800/50 text-center" data-reveal>
                    <h3 class="font-display font-bold text-2xl text-neutral-900 dark:text-white mb-4">
                        {t('publications.collaboration')}
                    </h3>
                    <p class="text-neutral-600 dark:text-neutral-400 mb-6 max-w-lg mx-auto">
                        {t('publications.collaborationText')}
                    </p>
                    <a
                        href={getLocalizedPath('/contact', lang)}
                        class="inline-flex items-center gap-2 px-6 py-3 bg-accent text-white rounded-full font-medium hover:bg-accent-600 transition-colors"
                    >
                        {t('cta.label')}
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                        </svg>
                    </a>
                </div>
            </div>
        </section>
    </main>

    <Footer lang={lang} />
</Layout>
